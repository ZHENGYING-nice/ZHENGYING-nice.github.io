<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡ä¸­å¿ƒè¿°èŒæŠ½ç­¾ç³»ç»Ÿï¼ˆ30äººç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            max-width: 600px; margin: 0 auto; background: white;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px; position: relative;
        }
        .header {
            text-align: center; margin-bottom: 30px;
            padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
        }
        .header h1 { color: #2c3e50; font-size: 24px; margin-bottom: 10px; }
        .counter {
            background: #e8f4fd; padding: 10px 20px; border-radius: 20px;
            display: inline-block; margin-top: 10px; font-weight: bold;
        }
        .counter.full { background: #f8d7da; color: #721c24; }
        
        .step {
            margin-bottom: 25px; padding: 20px; background: #f8f9fa;
            border-radius: 12px; border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        .step.active { border-left-color: #2ecc71; background: #e8f6f3; }
        .step.completed { border-left-color: #95a5a6; opacity: 0.9; }
        .step h2 {
            color: #2c3e50; margin-bottom: 12px; display: flex;
            align-items: center; font-size: 18px;
        }
        .step-number {
            display: inline-flex; align-items: center; justify-content: center;
            width: 26px; height: 26px; background: #3498db; color: white;
            border-radius: 50%; margin-right: 10px; font-weight: bold;
        }
        .step.active .step-number { background: #2ecc71; }
        .step.completed .step-number { background: #95a5a6; }
        
        input[type="text"] {
            width: 100%; padding: 14px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 16px; transition: border 0.3s ease;
            margin-bottom: 15px;
        }
        input[type="text"]:focus { border-color: #3498db; outline: none; }
        
        .btn {
            display: block; width: 100%; padding: 16px;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white; border: none; border-radius: 10px; font-size: 16px;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 8px 16px rgba(52,152,219,0.2);
        }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn.secondary { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .btn.success { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        
        .result-card {
            text-align: center; padding: 25px; margin: 20px 0;
            border-radius: 12px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            display: none; animation: fadeIn 0.5s ease;
        }
        .result-card.show { display: block; }
        .result-content {
            font-size: 28px; font-weight: bold; color: #e74c3c;
            margin: 15px 0;
        }
        .result-details {
            font-size: 18px; line-height: 1.5; color: #2c3e50;
            padding: 15px; background: white; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin: 15px 0;
            white-space: pre-line;
        }
        
        .badge {
            display: inline-block; padding: 8px 20px; border-radius: 20px;
            font-weight: bold; font-size: 16px; margin: 10px;
        }
        .lingzhu-badge { background: linear-gradient(135deg, #a8edea 0%, #74b9ff 100%); color: #2c3e50; }
        .mowan-badge { background: linear-gradient(135deg, #fed6e3 0%, #fd79a8 100%); color: #2c3e50; }
        .hunyuanzhu-badge { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); color: #2c3e50; }
        
        .locked-message {
            background: #f8d7da; color: #721c24; padding: 15px;
            border-radius: 8px; margin: 15px 0; text-align: center;
            border-left: 4px solid #dc3545;
        }
        
        .admin-panel {
            position: fixed; bottom: 80px; right: 20px; z-index: 1000;
            background: white; padding: 15px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); display: none;
            width: 300px; max-height: 400px; overflow-y: auto;
        }
        .admin-panel.show { display: block; }
        .admin-btn {
            background: #e74c3c; color: white; border: none;
            border-radius: 50%; width: 50px; height: 50px;
            font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(231,76,60,0.3);
            position: fixed; bottom: 20px; right: 20px; z-index: 1001;
        }
        
        .stats-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 10px; margin: 15px 0;
        }
        .stat-card {
            background: #f8f9fa; padding: 12px; border-radius: 8px;
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .limit-reached {
            background: #fff3cd; color: #856404; padding: 12px;
            border-radius: 8px; margin: 15px 0; text-align: center;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ² è´¢åŠ¡ä¸­å¿ƒè¿°èŒæŠ½ç­¾</h1>
            <p style="color: #7f8c8d; font-size: 14px;">30äººä¸“å± Â· æ¯è®¾å¤‡ä»…é™ä¸€æ¬¡</p>
            <div class="counter" id="participantCounter">
                å·²æŠ½ç­¾ï¼š<span id="currentCount">0</span>/30
            </div>
        </div>
        
        <!-- è®¾å¤‡ä¿¡æ¯ -->
        <div style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 14px; color: #2c3e50;">
                è®¾å¤‡è¯†åˆ«ç ï¼š<span id="deviceIdDisplay" style="font-family: monospace; background: #2c3e50; color: white; padding: 4px 8px; border-radius: 4px;"></span>
            </div>
        </div>
        
        <!-- æ­¥éª¤1ï¼šå¡«å†™å§“å -->
        <div class="step active" id="step1">
            <h2><span class="step-number">1</span> å¡«å†™å§“å</h2>
            
            <div id="duplicateWarning" style="display: none; background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                âš ï¸ æ‚¨çš„è®¾å¤‡å·²æŠ½ç­¾ï¼Œä¸å¯é‡å¤å‚ä¸
            </div>
            
            <div id="limitWarning" style="display: none;" class="limit-reached">
                âš ï¸ å·²è¾¾åˆ°30äººæŠ½ç­¾ä¸Šé™
            </div>
            
            <input type="text" id="userName" placeholder="è¯·è¾“å…¥çœŸå®å§“åï¼ˆ2-10ä¸ªå­—ç¬¦ï¼‰" maxlength="10" autocomplete="off">
            
            <button class="btn" id="startBtn">å¼€å§‹æŠ½ç­¾</button>
            
            <div style="margin-top: 15px; font-size: 12px; color: #7f8c8d; text-align: center;">
                <p>ğŸ“± æç¤ºï¼šè¯·å‹¿æ¸…é™¤æµè§ˆå™¨æ•°æ®ï¼Œå¦åˆ™ä¼šè¢«è§†ä¸ºæ–°è®¾å¤‡</p>
            </div>
        </div>
        
        <!-- æ­¥éª¤2-4ï¼ˆä¿æŒä¸å˜ï¼‰ -->
        <div class="step" id="step2" style="display: none;">
            <h2><span class="step-number">2</span> æŠ½å–èº«ä»½</h2>
            <p style="margin-bottom: 15px; color: #666;">ç‚¹å‡»æŒ‰é’®éšæœºæŠ½å–è¿°èŒèº«ä»½</p>
            <button class="btn" id="drawIdentityBtn">ğŸ”® æŠ½å–èº«ä»½</button>
            <div class="result-card" id="identityResult">
                <div style="font-size: 18px; color: #2c3e50;">æ‚¨çš„è¿°èŒèº«ä»½ï¼š</div>
                <div id="identityBadge" class="badge"></div>
                <div class="result-content" id="identityText"></div>
            </div>
        </div>
        
        <div class="step" id="step3" style="display: none;">
            <h2><span class="step-number">3</span> æŠ½å–é¢˜ç›®</h2>
            <p style="margin-bottom: 15px; color: #666;">æ ¹æ®èº«ä»½æŠ½å–å¯¹åº”é¢˜ç›®</p>
            <button class="btn secondary" id="drawQuestionBtn">ğŸ“ æŠ½å–é¢˜ç›®</button>
            <div class="result-card" id="questionResult">
                <div style="font-size: 18px; color: #2c3e50;">æ‚¨çš„è¿°èŒé¢˜ç›®ï¼š</div>
                <div class="result-details" id="questionText"></div>
            </div>
        </div>
        
        <div class="step" id="step4" style="display: none;">
            <h2><span class="step-number">4</span> å®ŒæˆæŠ½ç­¾</h2>
            <button class="btn success" id="completeBtn">âœ… å®ŒæˆæŠ½ç­¾</button>
            <div class="result-card" id="finalResult">
                <div style="font-size: 20px; color: #2c3e50; margin-bottom: 15px;">ğŸ‰ æŠ½ç­¾å®Œæˆï¼</div>
                <div style="font-size: 22px; font-weight: bold; color: #e74c3c; margin-bottom: 10px;" id="finalName"></div>
                <div id="finalIdentityBadge" class="badge"></div>
                <div class="result-details" id="finalQuestion" style="margin-top: 15px;"></div>
                <div class="locked-message" style="margin-top: 20px;">ğŸ”’ ç»“æœå·²é”å®šï¼Œä¸å¯ä¿®æ”¹</div>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜é¢æ¿ -->
        <button class="admin-btn" onclick="toggleAdminPanel()">ğŸ”§</button>
        <div class="admin-panel" id="adminPanel">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“Š ç®¡ç†é¢æ¿</h3>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="adminTotal">0</div>
                    <div class="stat-label">æ€»æŠ½ç­¾æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminUnique">0</div>
                    <div class="stat-label">ç‹¬ç«‹è®¾å¤‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminLingzhu">0</div>
                    <div class="stat-label">çµç </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminMowan">0</div>
                    <div class="stat-label">é­”ä¸¸</div>
                </div>
            </div>
            
            <div style="margin: 15px 0;">
                <button class="btn" onclick="exportAllData()" style="margin-bottom: 10px;">ğŸ“¥ å¯¼å‡ºå…¨éƒ¨æ•°æ®(CSV)</button>
                <button class="btn secondary" onclick="exportSimpleData()" style="margin-bottom: 10px;">ğŸ“‹ å¯¼å‡ºç®€ç‰ˆæ•°æ®</button>
                <button class="btn success" onclick="showAllResults()">ğŸ‘ï¸ æŸ¥çœ‹æ‰€æœ‰ç»“æœ</button>
            </div>
            
            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                <h4>ç³»ç»Ÿä¿¡æ¯</h4>
                <p style="font-size: 12px; color: #7f8c8d;">
                    ç®¡ç†å‘˜å¯†ç ï¼š<code>Finance2025@888</code><br>
                    æŠ½ç­¾ä¸Šé™ï¼š<span id="maxParticipants">30</span>äºº<br>
                    æœ€åæ›´æ–°ï¼š<span id="lastUpdate">-</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== ç³»ç»Ÿé…ç½® ====================
        const CONFIG = {
            MAX_PARTICIPANTS: 30, // æœ€å¤§æŠ½ç­¾äººæ•°
            ADMIN_PASSWORD: 'Finance2025@888',
            QUESTION_BANKS: {
                lingzhu: [
                    "Aï¼šå¦‚æœå¯ä»¥å›åˆ°2025å¹´åˆè·Ÿè‡ªå·±å¯¹è¯ï¼Œä½ ä¼šå¯¹è‡ªå·±è¯´äº›ä»€ä¹ˆï¼Ÿ",
                    "Bï¼šè¯„é€‰ä½ å¿ƒä¸­çš„'å¹´åº¦æœ€å¼ºé˜Ÿå‹'ï¼Œå¹¶ä¸ºä»–/å¥¹é¢å‘ä¸€ä¸ªå¥–é¡¹ï¼ˆæ¯”å¦‚ï¼š'äººé—´é•‡å®šå‰‚å¥–'ã€'æ°¸åŠ¨æœºå¼åŠ ç­ç‹‚äººå¥–'ã€'XXä¹‹ç‹'ï¼‰ï¼ŒåŠå‡†å¤‡ä¸€æ®µ30ç§’çš„é¢å¥–è¯ã€‚",
                    "Cï¼šå¦‚æœä¸ºä½ è‡ªå·±çš„æ˜å¹´åšä¸€ä¸ª'æ—¶é—´æŠ•å…¥é¢„ç®—'ï¼Œä½ æœ€æƒ³åœ¨å“ªæ–¹é¢'å¢åŠ æŠ•å…¥'ï¼Ÿï¼ˆæ¯”å¦‚ï¼šå¢åŠ ä¸æŸä½åŒäº‹çš„äº¤æµã€å¢åŠ ä¸€æ¬¡æŠ€èƒ½å­¦ä¹ ã€å¢åŠ ä¸€äº›æ”¾æ¾æ—¶åˆ»ï¼‰",
                    "Dï¼šåˆ†äº«ä¸€ä¸ªä½ ç”¨æ¥åœ¨ç¹å¿™å·¥ä½œä¸­å¿«é€Ÿæ”¾æ¾æˆ–è°ƒæ•´å¿ƒæƒ…çš„æ–¹æ³•ã€‚"
                ],
                mowan: [
                    "Aï¼šè¯·ç‚«è€€ä¸€é¡¹ä½ ä»Šå¹´å¯¹å›¢é˜Ÿåšå‡ºçš„æœ€ä¸æ­£ç»ä½†å¼¥è¶³çè´µçš„è´¡çŒ®ã€‚ï¼ˆæ¯”å¦‚ï¼šæ˜¯æ–¹åœ†åé‡Œå¥½åƒå¤–å–èµ„æºå¤§å¸ˆã€æˆ–æ˜¯å·¥ä½œç¾¤æ°”æ°›ç»„MVP...ï¼‰",
                    "Bï¼šä½ ç°åœ¨é©¬ä¸Šæœ‰ä¸€ä¸ªå‡èŒåŠ è–ªçš„æœºä¼šï¼Œæƒ³è¦ç»™é¢†å¯¼å±•ç¤ºçš„2-3ä¸ªçªå‡ºä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
                    "Cï¼šä¼ ç»Ÿè¿°èŒä¼šå°±æ˜¯ä¸€ç¾¤äººè½®æµç«™åœ¨å°ä¸Šè®²PPTï¼Œè€ŒæŠ€èƒ½è¿°èŒä¼šå°±æ˜¯åœ¨ä¼ ç»Ÿçš„åŸºç¡€ä¸ŠåŠ ä¸Šç‰¹åˆ«ç¯èŠ‚ã€‚å¦‚æœæ˜å¹´æ˜¯ç”±ä½ æ¥ä¸¾åŠæŠ€èƒ½è¿°èŒä¼šï¼Œä½ ä¼šä¸ºè¿°èŒä¼šå¢åŠ ä»€ä¹ˆæŠ€èƒ½ç¯èŠ‚ï¼Œä¸ºä»€ä¹ˆï¼Ÿ",
                    "Dï¼šæƒ³è±¡ç°åœ¨æœ‰ä¸€æŠŠåˆ€æ¶åœ¨ä½ çš„è„–å­ä¸Šï¼Œéœ€è¦ä½ è¯´å‡ºä½ å¸Œæœ›ä½ çš„ç›´å±/é—´æ¥é¢†å¯¼æ”¹è¿›çš„ä¸€ä¸ªé—®é¢˜å’Œå»ºè®®ã€‚",
                    "Eï¼šè¯·å”±ä¸€é¦–æ­Œæˆ–æœ—è¯»ä¸€é¦–è¯—è¡¨è¾¾ä»Šå¹´/æ­¤åˆ»çš„æ„Ÿå—æˆ–å¿ƒå¢ƒã€‚"
                ],
                hunyuanzhu: [
                    "ã€æ··å…ƒç ç‰¹æƒã€‘æ— éœ€æŠ½é¢˜ï¼Œå¯é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹å‘ï¼š\n1. ä»çµç é¢˜åº“ä¸­ä»»é€‰ä¸€é¢˜å›ç­”\n2. ä»é­”ä¸¸é¢˜åº“ä¸­ä»»é€‰ä¸€é¢˜å›ç­”\n3. è‡ªæ‹Ÿä¸€ä¸ªå…³äº'2025å¹´æˆé•¿ä¸çªç ´'çš„ä¸»é¢˜è¿›è¡Œåˆ†äº«"
                ]
            },
            IDENTITIES: [
                { name: "çµç ", code: "lingzhu", probability: 0.4 },
                { name: "é­”ä¸¸", code: "mowan", probability: 0.5 },
                { name: "æ··å…ƒç ", code: "hunyuanzhu", probability: 0.1 }
            ]
        };

        // ==================== çŠ¶æ€ç®¡ç† ====================
        let currentUser = {
            deviceId: '',
            name: '',
            hasDrawn: false,
            isDrawing: false,
            identity: null,
            question: ''
        };

        let allResults = [];
        let isLimitReached = false;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('30äººæŠ½ç­¾ç³»ç»Ÿåˆå§‹åŒ–...');
            
            // 1. ç”Ÿæˆè®¾å¤‡ID
            initDeviceId();
            
            // 2. åŠ è½½æ•°æ®
            loadStoredData();
            
            // 3. æ£€æŸ¥çŠ¶æ€
            checkUserStatus();
            checkLimitStatus();
            
            // 4. æ›´æ–°æ˜¾ç¤º
            updateParticipantCounter();
            
            // 5. è®¾ç½®äº‹ä»¶
            setupEventListeners();
            
            // 6. æ£€æŸ¥URLå‚æ•°
            checkUrlParams();
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æŠ½ç­¾äººæ•°:', allResults.length);
        });

        function initDeviceId() {
            let deviceId = localStorage.getItem('finance_device_id_30');
            
            if (!deviceId) {
                deviceId = 'DEV30_' + Date.now().toString(36).substr(-8) + 
                          '_' + Math.random().toString(36).substr(2, 6);
                localStorage.setItem('finance_device_id_30', deviceId);
            }
            
            currentUser.deviceId = deviceId;
            document.getElementById('deviceIdDisplay').textContent = deviceId.substr(0, 16);
        }

        function loadStoredData() {
            try {
                const stored = localStorage.getItem('finance_results_30');
                if (stored) {
                    allResults = JSON.parse(stored);
                }
            } catch (e) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', e);
                allResults = [];
            }
        }

        function checkUserStatus() {
            const existing = allResults.find(r => r.deviceId === currentUser.deviceId);
            
            if (existing) {
                currentUser.hasDrawn = true;
                currentUser.name = existing.name;
                currentUser.identity = { name: existing.identity, code: existing.code };
                currentUser.question = existing.question;
                
                showAlreadyDrawnResult(existing);
            }
        }

        function checkLimitStatus() {
            isLimitReached = allResults.length >= CONFIG.MAX_PARTICIPANTS;
            
            if (isLimitReached) {
                document.getElementById('limitWarning').style.display = 'block';
                document.getElementById('userName').disabled = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('participantCounter').classList.add('full');
            }
        }

        function showAlreadyDrawnResult(result) {
            document.getElementById('duplicateWarning').style.display = 'block';
            document.getElementById('userName').value = result.name;
            document.getElementById('userName').disabled = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'å·²æŠ½ç­¾';
            
            document.getElementById('finalName').textContent = result.name;
            const badge = document.getElementById('finalIdentityBadge');
            badge.textContent = result.identity;
            badge.className = `badge ${result.code}-badge`;
            document.getElementById('finalQuestion').textContent = result.question;
            
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step4').style.display = 'block';
            document.getElementById('finalResult').classList.add('show');
            document.getElementById('completeBtn').style.display = 'none';
        }

        function setupEventListeners() {
            const userNameInput = document.getElementById('userName');
            const startBtn = document.getElementById('startBtn');
            
            // å§“åè¾“å…¥éªŒè¯
            userNameInput.addEventListener('input', function() {
                const name = this.value.trim();
                startBtn.disabled = name.length < 2 || name.length > 10;
            });
            
            userNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !startBtn.disabled) {
                    startBtn.click();
                }
            });
            
            // å¼€å§‹æŠ½ç­¾
            startBtn.addEventListener('click', function() {
                if (isLimitReached) {
                    alert('å·²è¾¾åˆ°30äººæŠ½ç­¾ä¸Šé™');
                    return;
                }
                
                if (currentUser.hasDrawn) {
                    alert('æ‚¨çš„è®¾å¤‡å·²æŠ½ç­¾');
                    return;
                }
                
                const name = userNameInput.value.trim();
                if (name.length < 2 || name.length > 10) {
                    alert('è¯·è¾“å…¥2-10ä¸ªå­—ç¬¦çš„å§“å');
                    return;
                }
                
                // æ£€æŸ¥å§“åé‡å¤
                const nameUsed = allResults.find(r => r.name === name);
                if (nameUsed) {
                    alert('è¯¥å§“åå·²è¢«ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨çœŸå®å§“å');
                    return;
                }
                
                currentUser.name = name;
                currentUser.isDrawing = true;
                userNameInput.disabled = true;
                startBtn.disabled = true;
                
                goToStep(2);
            });
            
            // æŠ½å–èº«ä»½
            document.getElementById('drawIdentityBtn').addEventListener('click', function() {
                let random = Math.random();
                let cumulativeProbability = 0;
                
                for (const identity of CONFIG.IDENTITIES) {
                    cumulativeProbability += identity.probability;
                    if (random <= cumulativeProbability) {
                        currentUser.identity = identity;
                        break;
                    }
                }
                
                console.log('æŠ½åˆ°èº«ä»½:', currentUser.identity.name);
                
                document.getElementById('identityText').textContent = currentUser.identity.name;
                const badge = document.getElementById('identityBadge');
                badge.textContent = currentUser.identity.name;
                badge.className = `badge ${currentUser.identity.code}-badge`;
                document.getElementById('identityResult').classList.add('show');
                this.disabled = true;
                
                if (currentUser.identity.code === 'hunyuanzhu') {
                    currentUser.question = CONFIG.QUESTION_BANKS.hunyuanzhu[0];
                    setTimeout(() => {
                        goToStep(4);
                        document.getElementById('completeBtn').disabled = false;
                    }, 1500);
                } else {
                    setTimeout(() => {
                        goToStep(3);
                        document.getElementById('drawQuestionBtn').disabled = false;
                    }, 1500);
                }
            });
            
            // æŠ½å–é¢˜ç›®
            document.getElementById('drawQuestionBtn').addEventListener('click', function() {
                const questions = CONFIG.QUESTION_BANKS[currentUser.identity.code];
                const randomIndex = Math.floor(Math.random() * questions.length);
                currentUser.question = questions[randomIndex];
                
                document.getElementById('questionText').textContent = currentUser.question;
                document.getElementById('questionResult').classList.add('show');
                this.disabled = true;
                
                setTimeout(() => {
                    goToStep(4);
                    document.getElementById('completeBtn').disabled = false;
                }, 1500);
            });
            
            // å®ŒæˆæŠ½ç­¾
            document.getElementById('completeBtn').addEventListener('click', function() {
                saveResult();
                currentUser.hasDrawn = true;
                this.disabled = true;
                this.textContent = 'âœ… å·²é”å®š';
                
                showFinalResult();
                updateParticipantCounter();
                
                alert('ğŸ‰ æŠ½ç­¾å®Œæˆï¼æ‚¨æ˜¯ç¬¬' + allResults.length + 'ä½å‚ä¸è€…ã€‚');
            });
        }

        function goToStep(step) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            document.getElementById(`step${step}`).style.display = 'block';
            
            setTimeout(() => {
                document.getElementById(`step${step}`).scrollIntoView({ 
                    behavior: 'smooth', block: 'start' 
                });
            }, 100);
        }

        function saveResult() {
            const result = {
                name: currentUser.name,
                deviceId: currentUser.deviceId,
                identity: currentUser.identity.name,
                code: currentUser.identity.code,
                question: currentUser.question,
                timestamp: new Date().toLocaleString('zh-CN'),
                serialNo: allResults.length + 1
            };
            
            allResults.push(result);
            localStorage.setItem('finance_results_30', JSON.stringify(allResults));
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸Šé™
            if (allResults.length >= CONFIG.MAX_PARTICIPANTS) {
                isLimitReached = true;
                document.getElementById('limitWarning').style.display = 'block';
                document.getElementById('participantCounter').classList.add('full');
            }
        }

        function showFinalResult() {
            document.getElementById('finalName').textContent = currentUser.name;
            const badge = document.getElementById('finalIdentityBadge');
            badge.textContent = currentUser.identity.name;
            badge.className = `badge ${currentUser.identity.code}-badge`;
            document.getElementById('finalQuestion').textContent = currentUser.question;
            document.getElementById('finalResult').classList.add('show');
        }

        function updateParticipantCounter() {
            const count = allResults.length;
            document.getElementById('currentCount').textContent = count;
            
            if (count >= CONFIG.MAX_PARTICIPANTS) {
                document.getElementById('participantCounter').classList.add('full');
            }
        }

        // ==================== ç®¡ç†å‘˜åŠŸèƒ½ ====================
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                updateAdminStats();
            }
        }

        function updateAdminStats() {
            const uniqueDevices = new Set(allResults.map(r => r.deviceId)).size;
            const lingzhuCount = allResults.filter(r => r.code === 'lingzhu').length;
            const mowanCount = allResults.filter(r => r.code === 'mowan').length;
            const hunyuanzhuCount = allResults.filter(r => r.code === 'hunyuanzhu').length;
            
            document.getElementById('adminTotal').textContent = allResults.length;
            document.getElementById('adminUnique').textContent = uniqueDevices;
            document.getElementById('adminLingzhu').textContent = lingzhuCount;
            document.getElementById('adminMowan').textContent = mowanCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // å¯¼å‡ºå…¨éƒ¨æ•°æ®ï¼ˆè¯¦ç»†ç‰ˆï¼‰
        function exportAllData() {
            if (allResults.length === 0) {
                alert('æš‚æ— æ•°æ®');
                return;
            }
            
            let csv = 'åºå·,å§“å,è®¾å¤‡ID,èº«ä»½,é¢˜ç›®,æŠ½ç­¾æ—¶é—´\n';
            allResults.forEach((r, i) => {
                csv += `${i+1},"${r.name}","${r.deviceId}","${r.identity}","${r.question.replace(/"/g, '""')}","${r.timestamp}"\n`;
            });
            
            downloadCSV(csv, 'è´¢åŠ¡ä¸­å¿ƒæŠ½ç­¾è¯¦ç»†æ•°æ®');
            alert(`å·²å¯¼å‡º ${allResults.length} æ¡è¯¦ç»†è®°å½•`);
        }

        // å¯¼å‡ºç®€ç‰ˆæ•°æ®ï¼ˆä»…å§“åå’Œèº«ä»½ï¼‰
        function exportSimpleData() {
            if (allResults.length === 0) {
                alert('æš‚æ— æ•°æ®');
                return;
            }
            
            let csv = 'åºå·,å§“å,èº«ä»½,é¢˜ç›®æ‘˜è¦,æŠ½ç­¾æ—¶é—´\n';
            allResults.forEach((r, i) => {
                const questionSummary = r.question.length > 30 ? 
                    r.question.substring(0, 30) + '...' : r.question;
                csv += `${i+1},"${r.name}","${r.identity}","${questionSummary}","${r.timestamp}"\n`;
            });
            
            downloadCSV(csv, 'è´¢åŠ¡ä¸­å¿ƒæŠ½ç­¾ç®€ç‰ˆæ•°æ®');
            alert(`å·²å¯¼å‡º ${allResults.length} æ¡ç®€ç‰ˆè®°å½•`);
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showAllResults() {
            const resultsText = allResults.map(r => 
                `ã€${r.serialNo}ã€‘${r.name} - ${r.identity}\n` +
                `é¢˜ç›®ï¼š${r.question}\n` +
                `æ—¶é—´ï¼š${r.timestamp}\n` +
                `è®¾å¤‡ï¼š${r.deviceId.substr(0, 12)}...\n` +
                `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
            ).join('\n\n');
            
            alert(resultsText || 'æš‚æ— æ•°æ®');
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminKey = urlParams.get('admin');
            
            if (adminKey === CONFIG.ADMIN_PASSWORD) {
                document.getElementById('adminPanel').classList.add('show');
                updateAdminStats();
            }
        }

        // å…¨å±€å¯¼å‡ºå‡½æ•°ï¼ˆå¯ä»æ§åˆ¶å°è°ƒç”¨ï¼‰
        window.exportAllData = exportAllData;
        window.exportSimpleData = exportSimpleData;
        window.showAllResults = showAllResults;
        window.toggleAdminPanel = toggleAdminPanel;

        console.log('âœ… 30äººæŠ½ç­¾ç³»ç»Ÿå·²å°±ç»ª');
        console.log('ç®¡ç†å‘˜å¯†ç :', CONFIG.ADMIN_PASSWORD);
        console.log('å¯¼å‡ºå‡½æ•°: exportAllData(), exportSimpleData()');
    </script>
</body>
</html>