<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20251222-æŠ½ç­¾å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            min-height: 100vh; padding: 20px; color: #5D4037;
        }
        .container {
            max-width: 600px; margin: 0 auto; background: white;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(251, 140, 0, 0.1);
            padding: 30px; position: relative; border: 1px solid #FFB74D;
        }
        .header {
            text-align: center; margin-bottom: 30px;
            padding-bottom: 15px; border-bottom: 2px solid #FFB74D;
        }
        .header h1 { 
            color: #E65100; 
            font-size: 24px; 
            margin-bottom: 10px; 
        }
        .step {
            margin-bottom: 25px; padding: 20px; 
            background: #FFF8E1;
            border-radius: 12px; border-left: 4px solid #FF9800;
            transition: all 0.3s ease;
        }
        .step.active { 
            border-left-color: #FF8F00; 
            background: #FFECB3; 
        }
        .step.completed { 
            border-left-color: #BCAAA4; 
            opacity: 0.9; 
        }
        .step h2 {
            color: #5D4037; 
            margin-bottom: 12px; 
            display: flex;
            align-items: center; 
            font-size: 18px;
        }
        .step-number {
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            width: 26px; 
            height: 26px; 
            background: #FF9800; 
            color: white;
            border-radius: 50%; 
            margin-right: 10px; 
            font-weight: bold;
        }
        .step.active .step-number { background: #FF8F00; }
        .step.completed .step-number { background: #BCAAA4; }
        
        input[type="text"], input[type="password"] {
            width: 100%; 
            padding: 14px; 
            border: 2px solid #FFB74D;
            border-radius: 8px; 
            font-size: 16px; 
            transition: border 0.3s ease;
            margin-bottom: 15px;
            background: #FFF8E1;
        }
        input[type="text"]:focus, input[type="password"]:focus { 
            border-color: #FF9800; 
            outline: none; 
            background: white;
        }
        
        .btn {
            display: block; 
            width: 100%; 
            padding: 16px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px;
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px); 
            box-shadow: 0 8px 16px rgba(255, 152, 0, 0.3);
        }
        .btn:disabled { 
            background: #FFCCBC; 
            cursor: not-allowed; 
            color: #8D6E63;
        }
        .btn.secondary { 
            background: linear-gradient(135deg, #FFB74D 0%, #FF9800 100%); 
        }
        .btn.success { 
            background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); 
        }
        .btn.danger { 
            background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); 
        }
        .btn.danger:hover:not(:disabled) {
            box-shadow: 0 8px 16px rgba(244, 67, 54, 0.3);
        }
        
        .result-card {
            text-align: center; 
            padding: 25px; 
            margin: 20px 0;
            border-radius: 12px; 
            background: linear-gradient(135deg, #FFECB3 0%, #FFE0B2 100%);
            display: none; 
            animation: fadeIn 0.5s ease;
            border: 1px solid #FFCC80;
        }
        .result-card.show { display: block; }
        .result-content {
            font-size: 28px; 
            font-weight: bold; 
            color: #D84315;
            margin: 15px 0;
        }
        .result-details {
            font-size: 18px; 
            line-height: 1.5; 
            color: #5D4037;
            padding: 15px; 
            background: white; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(251, 140, 0, 0.05); 
            margin: 15px 0;
            white-space: pre-line;
            border: 1px solid #FFE0B2;
        }
        
        .badge {
            display: inline-block; 
            padding: 8px 20px; 
            border-radius: 20px;
            font-weight: bold; 
            font-size: 16px; 
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .lingzhu-badge { 
            background: linear-gradient(135deg, #FFF3E0 0%, #FFCC80 100%); 
            color: #E65100; 
            border: 1px solid #FFB74D;
        }
        .mowan-badge { 
            background: linear-gradient(135deg, #FFE0B2 0%, #FFAB91 100%); 
            color: #BF360C; 
            border: 1px solid #FF8A65;
        }
        .hunyuanzhu-badge { 
            background: linear-gradient(135deg, #FFECB3 0%, #FFD54F 100%); 
            color: #E65100; 
            border: 1px solid #FFB300;
        }
        
        .locked-message {
            background: #FFECB3; 
            color: #E65100; 
            padding: 15px;
            border-radius: 8px; 
            margin: 15px 0; 
            text-align: center;
            border-left: 4px solid #FF9800;
        }
        
        .admin-panel {
            position: fixed; 
            bottom: 80px; 
            right: 20px; 
            z-index: 1000;
            background: white; 
            padding: 15px; 
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.15); 
            display: none;
            width: 300px; 
            max-height: 400px; 
            overflow-y: auto;
            border: 2px solid #FF9800;
        }
        .admin-panel.show { display: block; }
        .admin-btn {
            background: #FF9800; 
            color: white; 
            border: none;
            border-radius: 50%; 
            width: 50px; 
            height: 50px;
            font-size: 20px; 
            cursor: pointer; 
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            z-index: 1001;
            transition: all 0.3s;
        }
        .admin-btn:hover {
            background: #F57C00;
            transform: scale(1.1);
        }
        
        .stats-grid {
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 8px; 
            margin: 15px 0;
        }
        .stat-card {
            background: #FFF3E0; 
            padding: 10px; 
            border-radius: 8px;
            text-align: center;
            border: 1px solid #FFE0B2;
        }
        .stat-value { 
            font-size: 18px; 
            font-weight: bold; 
            color: #E65100; 
        }
        .stat-label { 
            font-size: 11px; 
            color: #8D6E63; 
            margin-top: 3px; 
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .limit-reached {
            background: #FFF3E0; 
            color: #E65100; 
            padding: 12px;
            border-radius: 8px; 
            margin: 15px 0; 
            text-align: center;
            border-left: 4px solid #FF9800;
        }
        
        .name-warning {
            background: #FFEBEE; 
            color: #C62828; 
            padding: 10px;
            border-radius: 6px; 
            margin: 10px 0; 
            font-size: 14px;
            border-left: 3px solid #F44336;
            display: none;
        }
        
        .not-in-list-warning {
            background: #FFF3E0; 
            color: #FF6F00; 
            padding: 10px;
            border-radius: 6px; 
            margin: 10px 0; 
            font-size: 14px;
            border-left: 3px solid #FF9800;
            display: none;
        }
        
        .probability-info {
            background: #E8F5E9; 
            color: #2E7D32; 
            padding: 8px 12px;
            border-radius: 6px; 
            margin: 8px 0; 
            font-size: 12px;
            border-left: 3px solid #4CAF50;
            display: none;
        }
        
        /* ç®¡ç†å‘˜å…¥å£æ ·å¼ */
        .admin-entry {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002;
        }
        
        .admin-entry-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .admin-entry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.4);
        }
        
        .admin-entry-btn:active {
            transform: translateY(0);
        }
        
        /* é‡ç½®å¯†ç åŒºåŸŸæ ·å¼ */
        .reset-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #FFE0B2;
        }
        
        .password-input-group {
            margin-bottom: 10px;
        }
        
        .password-label {
            font-size: 12px;
            color: #5D4037;
            margin-bottom: 5px;
            display: block;
            font-weight: bold;
        }
        
        .password-status {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px 8px;
            border-radius: 4px;
            display: none;
        }
        
        .password-status.success {
            background: #E8F5E9;
            color: #2E7D32;
            border-left: 3px solid #4CAF50;
            display: block;
        }
        
        .password-status.error {
            background: #FFEBEE;
            color: #C62828;
            border-left: 3px solid #F44336;
            display: block;
        }
    </style>
</head>
<body>
    <!-- ç®¡ç†å‘˜å…¥å£æŒ‰é’® -->
    <div class="admin-entry">
        <button class="admin-entry-btn" onclick="toggleAdminPanel()">
            <span>ğŸ”§</span>
            <span>ç®¡ç†é¢æ¿</span>
        </button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ 20251222-æŠ½ç­¾å·¥å…·</h1>
            <p style="color: #8D6E63; font-size: 14px;">è¿°èŒæŠ½ç­¾ Â· 30äººä¸“å± Â· å¹³å‡åˆ†é…</p>
        </div>
        
        <!-- è®¾å¤‡ä¿¡æ¯ -->
        <div style="background: #FFF3E0; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #FFE0B2;">
            <div style="font-size: 14px; color: #5D4037;">
                è®¾å¤‡è¯†åˆ«ç ï¼š<span id="deviceIdDisplay" style="font-family: monospace; background: #5D4037; color: white; padding: 4px 8px; border-radius: 4px;"></span>
            </div>
        </div>
        
        <!-- æ­¥éª¤1ï¼šå¡«å†™å§“å -->
        <div class="step active" id="step1">
            <h2><span class="step-number">1</span> å¡«å†™å§“å</h2>
            
            <div id="duplicateWarning" style="display: none;" class="name-warning">
                âš ï¸ æ£€æµ‹åˆ°åŒåæäº¤ï¼è¯¥å§“åå·²è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨ã€‚è¯·ä½¿ç”¨çœŸå®å§“åï¼Œæ¯äººä»…é™æäº¤ä¸€æ¬¡ã€‚
            </div>
            
            <div id="deviceWarning" style="display: none;" class="name-warning">
                âš ï¸ æ‚¨çš„è®¾å¤‡å·²æŠ½ç­¾ï¼Œä¸å¯é‡å¤å‚ä¸
            </div>
            
            <div id="notInListWarning" style="display: none;" class="not-in-list-warning">
                âš ï¸ æ‚¨ä¸åœ¨æœ¬æ¬¡è¿°èŒåå•å†…
            </div>
            
            <div id="limitWarning" style="display: none;" class="limit-reached">
                âš ï¸ å·²è¾¾åˆ°30äººæŠ½ç­¾ä¸Šé™
            </div>
            
            <input type="text" id="userName" placeholder="è¯·è¾“å…¥åå•ä¸­çš„å§“åï¼ˆå®Œå…¨åŒ¹é…ï¼‰" maxlength="10" autocomplete="off">
            <div id="nameStatus" style="font-size: 12px; color: #8D6E63; margin-bottom: 10px; display: none;">
                <span id="nameStatusText"></span>
            </div>
            
            <button class="btn" id="startBtn">å¼€å§‹æŠ½ç­¾</button>
            
            <div style="margin-top: 15px; font-size: 12px; color: #8D6E63; text-align: center;">
                <p>ğŸ“± æç¤ºï¼šè¯·ç¡®ä¿å¡«å†™å§“åä¸åå•å®Œå…¨ä¸€è‡´</p>
            </div>
        </div>
        
        <!-- æ­¥éª¤2ï¼šæŠ½å–èº«ä»½ -->
        <div class="step" id="step2" style="display: none;">
            <h2><span class="step-number">2</span> æŠ½å–èº«ä»½</h2>
            <p style="margin-bottom: 15px; color: #8D6E63;">ç‚¹å‡»æŒ‰é’®éšæœºæŠ½å–è¿°èŒèº«ä»½</p>
            <button class="btn" id="drawIdentityBtn">ğŸ”® æŠ½å–èº«ä»½</button>
            <div class="result-card" id="identityResult">
                <div style="font-size: 18px; color: #5D4037;">æ‚¨çš„è¿°èŒèº«ä»½ï¼š</div>
                <div id="identityBadge" class="badge"></div>
                <div class="result-content" id="identityText"></div>
            </div>
        </div>
        
        <!-- æ­¥éª¤3ï¼šæŠ½å–é¢˜ç›® -->
        <div class="step" id="step3" style="display: none;">
            <h2><span class="step-number">3</span> æŠ½å–é¢˜ç›®</h2>
            <p style="margin-bottom: 15px; color: #8D6E63;">æ ¹æ®èº«ä»½æŠ½å–å¯¹åº”é¢˜ç›®</p>
            <button class="btn secondary" id="drawQuestionBtn">ğŸ“ æŠ½å–é¢˜ç›®</button>
            <div class="result-card" id="questionResult">
                <div style="font-size: 18px; color: #5D4037;">æ‚¨çš„è¿°èŒé¢˜ç›®ï¼š</div>
                <div class="result-details" id="questionText"></div>
            </div>
        </div>
        
        <!-- æ­¥éª¤4ï¼šå®Œæˆ -->
        <div class="step" id="step4" style="display: none;">
            <h2><span class="step-number">4</span> å®ŒæˆæŠ½ç­¾</h2>
            <button class="btn success" id="completeBtn">âœ… å®ŒæˆæŠ½ç­¾</button>
            <div class="result-card" id="finalResult">
                <div style="font-size: 20px; color: #5D4037; margin-bottom: 15px;">ğŸ‰ æŠ½ç­¾å®Œæˆï¼</div>
                <div style="font-size: 22px; font-weight: bold; color: #D84315; margin-bottom: 10px;" id="finalName"></div>
                <div id="finalIdentityBadge" class="badge"></div>
                <div class="result-details" id="finalQuestion" style="margin-top: 15px;"></div>
                <div class="locked-message" style="margin-top: 20px;">
                    ğŸ”’ ç»“æœå·²é”å®šï¼Œä¸å¯ä¿®æ”¹
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜é¢æ¿ -->
        <div class="admin-panel" id="adminPanel">
            <h3 style="margin-bottom: 15px; color: #5D4037;">ğŸ“Š åŠ¨æ€æ¦‚ç‡ç®¡ç†çœ‹æ¿</h3>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="adminTotal">0</div>
                    <div class="stat-label">æ€»æŠ½ç­¾æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminUnique">0</div>
                    <div class="stat-label">ç‹¬ç«‹è®¾å¤‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminLingzhu">0</div>
                    <div class="stat-label">çµç </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminMowan">0</div>
                    <div class="stat-label">é­”ä¸¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminHunyuan">0</div>
                    <div class="stat-label">æ··å…ƒç </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="adminRemaining">30</div>
                    <div class="stat-label">å‰©ä½™åé¢</div>
                </div>
            </div>
            
            <!-- åŠ¨æ€æ¦‚ç‡åˆ†å¸ƒæ˜¾ç¤º -->
            <div style="background: #FFF3E0; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #FFE0B2;">
                <div style="font-size: 12px; color: #5D4037; margin-bottom: 5px; font-weight: bold;">å½“å‰æ¦‚ç‡åˆ†å¸ƒ</div>
                <div style="font-size: 11px; color: #8D6E63;">
                    çµç : <span id="currentProbLingzhu">40%</span> Â· 
                    é­”ä¸¸: <span id="currentProbMowan">40%</span> Â· 
                    æ··å…ƒç : <span id="currentProbHunyuan">20%</span>
                </div>
                <div style="font-size: 11px; color: #8D6E63; margin-top: 3px;">
                    å·²æŠ½å–: çµç  <span id="usedLingzhu">0</span> Â· é­”ä¸¸ <span id="usedMowan">0</span> Â· æ··å…ƒç  <span id="usedHunyuan">0</span>
                </div>
            </div>
            
            <div style="margin: 15px 0;">
                <button class="btn" onclick="exportAllData()" style="margin-bottom: 10px;">ğŸ“¥ å¯¼å‡ºå…¨éƒ¨æ•°æ®(CSV)</button>
                <button class="btn secondary" onclick="exportProbabilityReport()" style="margin-bottom: 10px;">ğŸ“Š å¯¼å‡ºæ¦‚ç‡æŠ¥å‘Š</button>
                <button class="btn success" onclick="showAllResults()">ğŸ‘ï¸ æŸ¥çœ‹æ‰€æœ‰ç»“æœ</button>
            </div>
            
            <!-- é‡ç½®ç³»ç»ŸåŒºåŸŸ -->
            <div class="reset-section">
                <h4 style="color: #5D4037; margin-bottom: 10px;">ğŸ”„ ç³»ç»Ÿé‡ç½®</h4>
                <div class="password-input-group">
                    <label class="password-label">è¯·è¾“å…¥é‡ç½®å¯†ç ï¼š</label>
                    <input type="password" id="resetPassword" placeholder="è¾“å…¥å¯†ç " style="margin-bottom: 5px;">
                    <div id="passwordStatus" class="password-status"></div>
                </div>
                <button class="btn danger" onclick="resetSystemWithPassword()" style="margin-top: 5px;">âš ï¸ é‡ç½®å…¨éƒ¨æ•°æ®</button>
                <p style="font-size: 11px; color: #8D6E63; margin-top: 8px;">
                    æ³¨æ„ï¼šé‡ç½®å°†æ¸…é™¤æ‰€æœ‰æŠ½ç­¾è®°å½•å’Œæ¦‚ç‡çŠ¶æ€ï¼Œç³»ç»Ÿå°†æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼
                </p>
            </div>
            
            <div style="border-top: 1px solid #FFE0B2; padding-top: 15px; margin-top: 15px;">
                <h4>åŠ¨æ€æ¦‚ç‡è¯´æ˜</h4>
                <p style="font-size: 11px; color: #8D6E63;">
                    æ€»äººæ•°: 30äºº Â· åˆå§‹é…é¢: çµç 12äºº, é­”ä¸¸12äºº, æ··å…ƒç 6äºº<br>
                    æ¯æŠ½å–ä¸€æ¬¡ï¼Œå¯¹åº”èº«ä»½é…é¢å‡å°‘1<br>
                    æœ€åæ›´æ–°ï¼š<span id="lastUpdate">-</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== ç³»ç»Ÿé…ç½® ====================
        const CONFIG = {
            MAX_PARTICIPANTS: 30,
            RESET_PASSWORD: 'Yx!123451', // é‡ç½®å¯†ç 
            
            // åˆå§‹é…é¢ï¼š30äºº Ã— æ¦‚ç‡ = åˆå§‹æ•°é‡
            // çµç 40% = 12äººï¼Œé­”ä¸¸40% = 12äººï¼Œæ··å…ƒç 20% = 6äºº
            INITIAL_QUOTAS: {
                lingzhu: 12,  // 40% of 30 = 12
                mowan: 12,    // 40% of 30 = 12
                hunyuanzhu: 6 // 20% of 30 = 6
            },
            
            // é¢˜åº“é…ç½®
            QUESTION_BANKS: {
                lingzhu: [
                    { id: "A", text: "å¦‚æœå¯ä»¥å›åˆ°2025å¹´åˆè·Ÿè‡ªå·±å¯¹è¯ï¼Œä½ ä¼šå¯¹è‡ªå·±è¯´äº›ä»€ä¹ˆï¼Ÿ" },
                    { id: "B", text: "è¯„é€‰ä½ å¿ƒä¸­çš„'å¹´åº¦æœ€å¼ºé˜Ÿå‹'ï¼Œå¹¶ä¸ºä»–/å¥¹é¢å‘ä¸€ä¸ªå¥–é¡¹ï¼ˆæ¯”å¦‚ï¼š'äººé—´é•‡å®šå‰‚å¥–'ã€'æ°¸åŠ¨æœºå¼åŠ ç­ç‹‚äººå¥–'ã€'XXä¹‹ç‹'ï¼‰ï¼ŒåŠå‡†å¤‡ä¸€æ®µ30ç§’çš„é¢å¥–è¯ã€‚" },
                    { id: "C", text: "å¦‚æœä¸ºä½ è‡ªå·±çš„æ˜å¹´åšä¸€ä¸ª'æ—¶é—´æŠ•å…¥é¢„ç®—'ï¼Œä½ æœ€æƒ³åœ¨å“ªæ–¹é¢'å¢åŠ æŠ•å…¥'ï¼Ÿï¼ˆæ¯”å¦‚ï¼šå¢åŠ ä¸æŸä½åŒäº‹çš„äº¤æµã€å¢åŠ ä¸€æ¬¡æŠ€èƒ½å­¦ä¹ ã€å¢åŠ ä¸€äº›æ”¾æ¾æ—¶åˆ»ï¼‰" },
                    { id: "D", text: "åˆ†äº«ä¸€ä¸ªä½ ç”¨æ¥åœ¨ç¹å¿™å·¥ä½œä¸­å¿«é€Ÿæ”¾æ¾æˆ–è°ƒæ•´å¿ƒæƒ…çš„æ–¹æ³•ã€‚" }
                ],
                mowan: [
                    { id: "A", text: "è¯·ç‚«è€€ä¸€é¡¹ä½ ä»Šå¹´å¯¹å›¢é˜Ÿåšå‡ºçš„æœ€ä¸æ­£ç»ä½†å¼¥è¶³çè´µçš„è´¡çŒ®ã€‚ï¼ˆæ¯”å¦‚ï¼šæ˜¯æ–¹åœ†åé‡Œå¥½åƒå¤–å–èµ„æºå¤§å¸ˆã€æˆ–æ˜¯å·¥ä½œç¾¤æ°”æ°›ç»„MVP...ï¼‰" },
                    { id: "B", text: "ä½ ç°åœ¨é©¬ä¸Šæœ‰ä¸€ä¸ªå‡èŒåŠ è–ªçš„æœºä¼šï¼Œæƒ³è¦ç»™é¢†å¯¼å±•ç¤ºçš„2-3ä¸ªçªå‡ºä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆï¼Ÿ" },
                    { id: "C", text: "ä¼ ç»Ÿè¿°èŒä¼šå°±æ˜¯ä¸€ç¾¤äººè½®æµç«™åœ¨å°ä¸Šè®²PPTï¼Œè€ŒæŠ€èƒ½è¿°èŒä¼šå°±æ˜¯åœ¨ä¼ ç»Ÿçš„åŸºç¡€ä¸ŠåŠ ä¸Šç‰¹åˆ«ç¯èŠ‚ã€‚å¦‚æœæ˜å¹´æ˜¯ç”±ä½ æ¥ä¸¾åŠæŠ€èƒ½è¿°èŒä¼šï¼Œä½ ä¼šä¸ºè¿°èŒä¼šå¢åŠ ä»€ä¹ˆæŠ€èƒ½ç¯èŠ‚ï¼Œä¸ºä»€ä¹ˆï¼Ÿ" },
                    { id: "D", text: "æƒ³è±¡ç°åœ¨æœ‰ä¸€æŠŠåˆ€æ¶åœ¨ä½ çš„è„–å­ä¸Šï¼Œéœ€è¦ä½ è¯´å‡ºä½ å¸Œæœ›ä½ çš„ç›´å±/é—´æ¥é¢†å¯¼æ”¹è¿›çš„ä¸€ä¸ªé—®é¢˜å’Œå»ºè®®ã€‚" },
                    { id: "E", text: "è¯·å”±ä¸€é¦–æ­Œæˆ–æœ—è¯»ä¸€é¦–è¯—è¡¨è¾¾ä»Šå¹´/æ­¤åˆ»çš„æ„Ÿå—æˆ–å¿ƒå¢ƒã€‚" }
                ],
                hunyuanzhu: [
                    { id: "T", text: "ã€æ··å…ƒç ç‰¹æƒã€‘æ— éœ€æŠ½é¢˜ï¼Œå¯é€‰æ‹©ä»¥ä¸‹ä»»ä¸€æ–¹å‘ï¼š\n1. ä»çµç é¢˜åº“ä¸­ä»»é€‰ä¸€é¢˜å›ç­”\n2. ä»é­”ä¸¸é¢˜åº“ä¸­ä»»é€‰ä¸€é¢˜å›ç­”\n3. è‡ªæ‹Ÿä¸€ä¸ªå…³äº'2025å¹´æˆé•¿ä¸çªç ´'çš„ä¸»é¢˜è¿›è¡Œåˆ†äº«" }
                ]
            }
        };

        // ==================== è¿°èŒäººå‘˜åå• ====================
        const PARTICIPANT_LIST = [
            "æ¨Šæ¯“é¾™", "ä»£é¹", "å…³ç’", "ç‹ç•¯", "æä¼Ÿä¼Ÿ", 
            "åˆ˜å­ç’‡", "æ¨Šåè£•", "é»„æ™“è±", "è°¢æ™ºæ…§", "é’Ÿæ–‡æµ©", 
            "è¢æˆå¿ ", "é™ˆæ³¢", "ä½™æµ©", "é»„å­Ÿå­œ", "éƒ‘è¹", 
            "éƒ­é™é›¯", "é™ˆå®¶å®", "é‚±å˜‰æµ©", "å­”åº†ç››", "è°­æ™“èŠ¸", 
            "é‚±æƒ æ³¯", "åˆ˜æ¬£ç’", "éƒ‘ä¿Š", "ç§¦ä¹è¯—", "è·¯ç„¶", 
            "æ—ä¸½å", "æ—ä¸¹ä¸¹", "é€„æ·‘åª›", "åˆ˜å€©å©·", "å¤‡ç”¨"
        ];

        // ==================== åŠ¨æ€æ¦‚ç‡ç®¡ç†ç³»ç»Ÿ ====================
        let probabilitySystem = {
            // å½“å‰å‰©ä½™é…é¢
            remainingQuotas: { ...CONFIG.INITIAL_QUOTAS },
            
            // å·²ä½¿ç”¨é…é¢
            usedQuotas: {
                lingzhu: 0,
                mowan: 0,
                hunyuanzhu: 0
            },
            
            // é¢˜ç›®ä½¿ç”¨æƒ…å†µ
            usedQuestions: {
                lingzhu: { "A": 0, "B": 0, "C": 0, "D": 0 },
                mowan: { "A": 0, "B": 0, "C": 0, "D": 0, "E": 0 }
            },
            
            // è®¡ç®—å½“å‰æ¦‚ç‡
            calculateCurrentProbabilities: function() {
                const totalRemaining = this.remainingQuotas.lingzhu + 
                                     this.remainingQuotas.mowan + 
                                     this.remainingQuotas.hunyuanzhu;
                
                if (totalRemaining === 0) return { lingzhu: 0, mowan: 0, hunyuanzhu: 0 };
                
                return {
                    lingzhu: this.remainingQuotas.lingzhu / totalRemaining,
                    mowan: this.remainingQuotas.mowan / totalRemaining,
                    hunyuanzhu: this.remainingQuotas.hunyuanzhu / totalRemaining
                };
            },
            
            // æ ¹æ®å½“å‰æ¦‚ç‡éšæœºé€‰æ‹©èº«ä»½
            selectIdentity: function() {
                const probs = this.calculateCurrentProbabilities();
                const random = Math.random();
                
                console.log("å½“å‰æ¦‚ç‡åˆ†å¸ƒ:", probs);
                console.log("éšæœºæ•°:", random);
                
                let cumulative = 0;
                
                // æŒ‰æ¦‚ç‡é€‰æ‹©èº«ä»½
                if (random < (cumulative + probs.lingzhu) && this.remainingQuotas.lingzhu > 0) {
                    return "lingzhu";
                }
                cumulative += probs.lingzhu;
                
                if (random < (cumulative + probs.mowan) && this.remainingQuotas.mowan > 0) {
                    return "mowan";
                }
                cumulative += probs.mowan;
                
                if (random < (cumulative + probs.hunyuanzhu) && this.remainingQuotas.hunyuanzhu > 0) {
                    return "hunyuanzhu";
                }
                
                // å¦‚æœç”±äºå››èˆäº”å…¥é—®é¢˜æœªé€‰ä¸­ï¼Œé€‰æ‹©å‰©ä½™é…é¢æœ€å¤šçš„
                const maxQuota = Math.max(
                    this.remainingQuotas.lingzhu,
                    this.remainingQuotas.mowan,
                    this.remainingQuotas.hunyuanzhu
                );
                
                if (maxQuota === this.remainingQuotas.lingzhu) return "lingzhu";
                if (maxQuota === this.remainingQuotas.mowan) return "mowan";
                return "hunyuanzhu";
            },
            
            // é€‰æ‹©é¢˜ç›®ï¼ˆè€ƒè™‘å·²ä½¿ç”¨æƒ…å†µï¼‰
            selectQuestion: function(identity) {
                if (identity === "hunyuanzhu") {
                    return CONFIG.QUESTION_BANKS.hunyuanzhu[0];
                }
                
                const questions = CONFIG.QUESTION_BANKS[identity];
                const used = this.usedQuestions[identity];
                
                // è®¡ç®—æ¯ä¸ªé¢˜ç›®çš„æƒé‡ï¼ˆä½¿ç”¨æ¬¡æ•°è¶Šå°‘ï¼Œæƒé‡è¶Šé«˜ï¼‰
                const weights = questions.map(q => {
                    const usedCount = used[q.id] || 0;
                    // åŸºç¡€æƒé‡10ï¼Œæ¯ä½¿ç”¨ä¸€æ¬¡å‡å°‘2ï¼Œæœ€ä½æƒé‡ä¸º1
                    return Math.max(1, 10 - (usedCount * 2));
                });
                
                // è®¡ç®—æ€»æƒé‡
                const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                
                // æ ¹æ®æƒé‡éšæœºé€‰æ‹©
                let random = Math.random() * totalWeight;
                for (let i = 0; i < questions.length; i++) {
                    random -= weights[i];
                    if (random <= 0) {
                        return questions[i];
                    }
                }
                
                // é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ª
                return questions[0];
            },
            
            // è®°å½•ä½¿ç”¨
            recordUsage: function(identity, questionId) {
                // æ›´æ–°èº«ä»½é…é¢
                if (this.remainingQuotas[identity] > 0) {
                    this.remainingQuotas[identity]--;
                    this.usedQuotas[identity]++;
                }
                
                // æ›´æ–°é¢˜ç›®ä½¿ç”¨æƒ…å†µï¼ˆå¦‚æœä¸æ˜¯æ··å…ƒç ï¼‰
                if (identity !== "hunyuanzhu" && questionId) {
                    this.usedQuestions[identity][questionId] = 
                        (this.usedQuestions[identity][questionId] || 0) + 1;
                }
                
                this.saveToStorage();
                this.updateDisplay();
            },
            
            // ä»æ•°æ®ä¸­æ¢å¤çŠ¶æ€
            restoreFromResults: function(results) {
                // é‡ç½®
                this.remainingQuotas = { ...CONFIG.INITIAL_QUOTAS };
                this.usedQuotas = { lingzhu: 0, mowan: 0, hunyuanzhu: 0 };
                this.usedQuestions = {
                    lingzhu: { "A": 0, "B": 0, "C": 0, "D": 0 },
                    mowan: { "A": 0, "B": 0, "C": 0, "D": 0, "E": 0 }
                };
                
                // æ ¹æ®å·²æœ‰ç»“æœæ¢å¤çŠ¶æ€
                results.forEach(result => {
                    const identity = result.code;
                    
                    // æ›´æ–°èº«ä»½é…é¢
                    if (this.remainingQuotas[identity] > 0) {
                        this.remainingQuotas[identity]--;
                        this.usedQuotas[identity]++;
                    }
                    
                    // æ›´æ–°é¢˜ç›®ä½¿ç”¨ï¼ˆéœ€è¦ä»é¢˜ç›®ä¸­æå–IDï¼‰
                    if (identity !== "hunyuanzhu" && result.question) {
                        // ä»é¢˜ç›®æ–‡æœ¬ä¸­æå–IDï¼ˆå‡è®¾æ ¼å¼ä¸º"IDï¼š"å¼€å¤´ï¼‰
                        const match = result.question.match(/^([A-E])ï¼š/);
                        if (match && match[1]) {
                            const questionId = match[1];
                            this.usedQuestions[identity][questionId] = 
                                (this.usedQuestions[identity][questionId] || 0) + 1;
                        }
                    }
                });
            },
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveToStorage: function() {
                const data = {
                    remainingQuotas: this.remainingQuotas,
                    usedQuotas: this.usedQuotas,
                    usedQuestions: this.usedQuestions
                };
                localStorage.setItem('probability_system_v1', JSON.stringify(data));
            },
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            loadFromStorage: function() {
                try {
                    const data = JSON.parse(localStorage.getItem('probability_system_v1'));
                    if (data) {
                        this.remainingQuotas = data.remainingQuotas || { ...CONFIG.INITIAL_QUOTAS };
                        this.usedQuotas = data.usedQuotas || { lingzhu: 0, mowan: 0, hunyuanzhu: 0 };
                        this.usedQuestions = data.usedQuestions || {
                            lingzhu: { "A": 0, "B": 0, "C": 0, "D": 0 },
                            mowan: { "A": 0, "B": 0, "C": 0, "D": 0, "E": 0 }
                        };
                    }
                } catch (e) {
                    console.log('ä½¿ç”¨åˆå§‹æ¦‚ç‡è®¾ç½®');
                }
            },
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay: function() {
                // æ›´æ–°ç®¡ç†é¢æ¿
                this.updateAdminPanel();
            },
            
            // æ›´æ–°ç®¡ç†é¢æ¿
            updateAdminPanel: function() {
                const probs = this.calculateCurrentProbabilities();
                
                document.getElementById('currentProbLingzhu').textContent = 
                    `${Math.round(probs.lingzhu * 100)}%`;
                document.getElementById('currentProbMowan').textContent = 
                    `${Math.round(probs.mowan * 100)}%`;
                document.getElementById('currentProbHunyuan').textContent = 
                    `${Math.round(probs.hunyuanzhu * 100)}%`;
                
                document.getElementById('usedLingzhu').textContent = this.usedQuotas.lingzhu;
                document.getElementById('usedMowan').textContent = this.usedQuotas.mowan;
                document.getElementById('usedHunyuan').textContent = this.usedQuotas.hunyuanzhu;
            },
            
            // è·å–è¯¦ç»†æŠ¥å‘Š
            getDetailedReport: function() {
                const probs = this.calculateCurrentProbabilities();
                const totalUsed = this.usedQuotas.lingzhu + this.usedQuotas.mowan + this.usedQuotas.hunyuanzhu;
                
                return {
                    quotas: {
                        initial: CONFIG.INITIAL_QUOTAS,
                        remaining: this.remainingQuotas,
                        used: this.usedQuotas
                    },
                    probabilities: {
                        current: probs,
                        initial: {
                            lingzhu: CONFIG.INITIAL_QUOTAS.lingzhu / 30,
                            mowan: CONFIG.INITIAL_QUOTAS.mowan / 30,
                            hunyuanzhu: CONFIG.INITIAL_QUOTAS.hunyuanzhu / 30
                        }
                    },
                    questionUsage: this.usedQuestions,
                    summary: {
                        totalParticipants: totalUsed,
                        remainingSlots: 30 - totalUsed,
                        distributionFairness: this.calculateFairnessScore()
                    }
                };
            },
            
            // è®¡ç®—åˆ†é…å…¬å¹³æ€§åˆ†æ•°
            calculateFairnessScore: function() {
                const expected = {
                    lingzhu: 12,  // 40% of 30
                    mowan: 12,    // 40% of 30
                    hunyuanzhu: 6 // 20% of 30
                };
                
                const actual = this.usedQuotas;
                const total = actual.lingzhu + actual.mowan + actual.hunyuanzhu;
                
                if (total === 0) return 100;
                
                let score = 100;
                
                // è®¡ç®—æ¯ä¸ªèº«ä»½çš„å®é™…æ¯”ä¾‹ä¸æœŸæœ›æ¯”ä¾‹çš„å·®å¼‚
                for (const identity in expected) {
                    const expectedPct = expected[identity] / 30;
                    const actualPct = (actual[identity] || 0) / total;
                    const diff = Math.abs(expectedPct - actualPct);
                    
                    // å·®å¼‚è¶Šå¤§ï¼Œæ‰£åˆ†è¶Šå¤š
                    score -= diff * 50;
                }
                
                return Math.max(0, Math.round(score));
            },
            
            // é‡ç½®ç³»ç»Ÿ
            resetSystem: function() {
                this.remainingQuotas = { ...CONFIG.INITIAL_QUOTAS };
                this.usedQuotas = { lingzhu: 0, mowan: 0, hunyuanzhu: 0 };
                this.usedQuestions = {
                    lingzhu: { "A": 0, "B": 0, "C": 0, "D": 0 },
                    mowan: { "A": 0, "B": 0, "C": 0, "D": 0, "E": 0 }
                };
                this.saveToStorage();
                this.updateDisplay();
            }
        };

        // ==================== çŠ¶æ€ç®¡ç† ====================
        let currentUser = {
            deviceId: '',
            name: '',
            hasDrawn: false,
            isDrawing: false,
            identity: null,
            question: null
        };

        let allResults = [];
        let isLimitReached = false;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æŠ½ç­¾ç³»ç»Ÿåˆå§‹åŒ–...');
            
            // 1. ç”Ÿæˆè®¾å¤‡ID
            initDeviceId();
            
            // 2. åŠ è½½æ•°æ®
            loadStoredData();
            
            // 3. åŠ è½½æ¦‚ç‡ç³»ç»Ÿ
            probabilitySystem.loadFromStorage();
            
            // 4. æ ¹æ®å·²æœ‰ç»“æœæ¢å¤æ¦‚ç‡çŠ¶æ€
            probabilitySystem.restoreFromResults(allResults);
            
            // 5. æ£€æŸ¥çŠ¶æ€
            checkUserStatus();
            checkLimitStatus();
            
            // 6. è®¾ç½®äº‹ä»¶
            setupEventListeners();
            
            // 7. è®¾ç½®å¯†ç è¾“å…¥æ¡†çš„Enteré”®äº‹ä»¶
            document.getElementById('resetPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    resetSystemWithPassword();
                }
            });
            
            console.log('åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æŠ½ç­¾äººæ•°:', allResults.length);
        });

        function initDeviceId() {
            let deviceId = localStorage.getItem('finance_device_id_v3');
            
            if (!deviceId) {
                const userAgentHash = hashCode(navigator.userAgent);
                const timeHash = Date.now().toString(36);
                const randomHash = Math.random().toString(36).substr(2, 8);
                
                deviceId = `DEV_${userAgentHash.substr(0, 6)}_${timeHash.substr(-6)}_${randomHash}`;
                localStorage.setItem('finance_device_id_v3', deviceId);
            }
            
            currentUser.deviceId = deviceId;
            document.getElementById('deviceIdDisplay').textContent = deviceId.substr(0, 16);
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        function loadStoredData() {
            try {
                const stored = localStorage.getItem('finance_results_v3');
                if (stored) {
                    allResults = JSON.parse(stored);
                }
            } catch (e) {
                allResults = [];
            }
        }

        function checkUserStatus() {
            const existingByDevice = allResults.find(r => r.deviceId === currentUser.deviceId);
            
            if (existingByDevice) {
                currentUser.hasDrawn = true;
                currentUser.name = existingByDevice.name;
                currentUser.identity = { 
                    name: existingByDevice.identity, 
                    code: existingByDevice.code 
                };
                currentUser.question = existingByDevice.question;
                
                showAlreadyDrawnResult(existingByDevice);
                return;
            }
            
            const userNameInput = document.getElementById('userName');
            userNameInput.addEventListener('input', function() {
                const name = this.value.trim();
                const nameStatus = document.getElementById('nameStatus');
                const nameStatusText = document.getElementById('nameStatusText');
                const notInListWarning = document.getElementById('notInListWarning');
                const duplicateWarning = document.getElementById('duplicateWarning');
                const startBtn = document.getElementById('startBtn');
                
                // éšè—æ‰€æœ‰è­¦å‘Š
                notInListWarning.style.display = 'none';
                duplicateWarning.style.display = 'none';
                nameStatus.style.display = 'none';
                
                if (name.length === 0) {
                    startBtn.disabled = true;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨åå•å†…
                const isInList = PARTICIPANT_LIST.includes(name);
                
                if (!isInList) {
                    // ä¸åœ¨åå•å†…
                    notInListWarning.style.display = 'block';
                    startBtn.disabled = true;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦é‡å¤
                const nameUsed = allResults.find(r => r.name === name && r.deviceId !== currentUser.deviceId);
                if (nameUsed) {
                    duplicateWarning.style.display = 'block';
                    startBtn.disabled = true;
                    nameStatus.style.display = 'block';
                    nameStatusText.innerHTML = `âš ï¸ <strong>${name}</strong> å·²è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨`;
                    nameStatus.style.color = '#D32F2F';
                } else {
                    startBtn.disabled = false;
                    nameStatus.style.display = 'block';
                    nameStatusText.innerHTML = `âœ“ <strong>${name}</strong> éªŒè¯é€šè¿‡`;
                    nameStatus.style.color = '#388E3C';
                }
            });
        }

        function checkLimitStatus() {
            const totalUsed = probabilitySystem.usedQuotas.lingzhu + 
                            probabilitySystem.usedQuotas.mowan + 
                            probabilitySystem.usedQuotas.hunyuanzhu;
            isLimitReached = totalUsed >= CONFIG.MAX_PARTICIPANTS;
            
            if (isLimitReached) {
                document.getElementById('limitWarning').style.display = 'block';
                document.getElementById('userName').disabled = true;
                document.getElementById('startBtn').disabled = true;
            }
        }

        function showAlreadyDrawnResult(result) {
            document.getElementById('deviceWarning').style.display = 'block';
            document.getElementById('userName').value = result.name;
            document.getElementById('userName').disabled = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'å·²æŠ½ç­¾';
            
            document.getElementById('finalName').textContent = result.name;
            const badge = document.getElementById('finalIdentityBadge');
            badge.textContent = result.identity;
            badge.className = `badge ${result.code}-badge`;
            document.getElementById('finalQuestion').textContent = result.question;
            
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step4').style.display = 'block';
            document.getElementById('finalResult').classList.add('show');
            document.getElementById('completeBtn').style.display = 'none';
            
            const existingIndex = allResults.findIndex(r => r.deviceId === currentUser.deviceId);
            if (existingIndex !== -1) {
                const serialNo = allResults[existingIndex].serialNo || (existingIndex + 1);
                const serialInfo = document.createElement('div');
                serialInfo.style.marginTop = '10px';
                serialInfo.style.fontSize = '14px';
                serialInfo.style.color = '#8D6E63';
                serialInfo.innerHTML = `ğŸ“ æ‚¨æ˜¯ç¬¬ <strong>${serialNo}</strong> ä½å‚ä¸è€…`;
                document.getElementById('finalName').parentNode.appendChild(serialInfo);
            }
        }

        function setupEventListeners() {
            const userNameInput = document.getElementById('userName');
            const startBtn = document.getElementById('startBtn');
            
            userNameInput.addEventListener('input', function() {
                const name = this.value.trim();
                const nameStatus = document.getElementById('nameStatus');
                const nameStatusText = document.getElementById('nameStatusText');
                const notInListWarning = document.getElementById('notInListWarning');
                const duplicateWarning = document.getElementById('duplicateWarning');
                
                // éšè—æ‰€æœ‰è­¦å‘Š
                notInListWarning.style.display = 'none';
                duplicateWarning.style.display = 'none';
                nameStatus.style.display = 'none';
                
                if (name.length === 0) {
                    startBtn.disabled = true;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨åå•å†…
                const isInList = PARTICIPANT_LIST.includes(name);
                
                if (!isInList) {
                    // ä¸åœ¨åå•å†…
                    notInListWarning.style.display = 'block';
                    startBtn.disabled = true;
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦é‡å¤
                const nameUsed = allResults.find(r => r.name === name && r.deviceId !== currentUser.deviceId);
                if (nameUsed) {
                    duplicateWarning.style.display = 'block';
                    startBtn.disabled = true;
                    nameStatus.style.display = 'block';
                    nameStatusText.innerHTML = `âš ï¸ <strong>${name}</strong> å·²è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨`;
                    nameStatus.style.color = '#D32F2F';
                } else {
                    startBtn.disabled = false;
                    nameStatus.style.display = 'block';
                    nameStatusText.innerHTML = `âœ“ <strong>${name}</strong> éªŒè¯é€šè¿‡`;
                    nameStatus.style.color = '#388E3C';
                }
            });
            
            userNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !startBtn.disabled) {
                    startBtn.click();
                }
            });
            
            startBtn.addEventListener('click', function() {
                checkLimitStatus();
                
                if (isLimitReached) {
                    alert('å·²è¾¾åˆ°30äººæŠ½ç­¾ä¸Šé™');
                    return;
                }
                
                if (currentUser.hasDrawn) {
                    alert('æ‚¨çš„è®¾å¤‡å·²æŠ½ç­¾');
                    return;
                }
                
                const name = userNameInput.value.trim();
                if (name.length === 0) {
                    alert('è¯·è¾“å…¥å§“å');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦åœ¨åå•å†…
                const isInList = PARTICIPANT_LIST.includes(name);
                if (!isInList) {
                    alert('æ‚¨ä¸åœ¨æœ¬æ¬¡è¿°èŒåå•å†…');
                    return;
                }
                
                const nameUsed = allResults.find(r => r.name === name && r.deviceId !== currentUser.deviceId);
                if (nameUsed) {
                    alert('è¯¥å§“åå·²è¢«å…¶ä»–åŒäº‹ä½¿ç”¨ï¼Œè¯·ä½¿ç”¨çœŸå®å§“åã€‚æ¯äººä»…é™æäº¤ä¸€æ¬¡ã€‚');
                    return;
                }
                
                currentUser.name = name;
                currentUser.isDrawing = true;
                userNameInput.disabled = true;
                startBtn.disabled = true;
                
                goToStep(2);
            });
            
            // æŠ½å–èº«ä»½ï¼ˆä½¿ç”¨åŠ¨æ€æ¦‚ç‡ç³»ç»Ÿï¼‰
            document.getElementById('drawIdentityBtn').addEventListener('click', function() {
                // ä½¿ç”¨æ¦‚ç‡ç³»ç»Ÿé€‰æ‹©èº«ä»½
                const selectedIdentity = probabilitySystem.selectIdentity();
                
                // è®¾ç½®å½“å‰ç”¨æˆ·èº«ä»½
                let identityName = "";
                switch(selectedIdentity) {
                    case "lingzhu":
                        identityName = "çµç ";
                        break;
                    case "mowan":
                        identityName = "é­”ä¸¸";
                        break;
                    case "hunyuanzhu":
                        identityName = "æ··å…ƒç ";
                        break;
                }
                
                currentUser.identity = {
                    name: identityName,
                    code: selectedIdentity
                };
                
                console.log(`æŠ½ä¸­èº«ä»½: ${identityName}, ä»£ç : ${selectedIdentity}`);
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('identityText').textContent = identityName;
                const badge = document.getElementById('identityBadge');
                badge.textContent = identityName;
                badge.className = `badge ${selectedIdentity}-badge`;
                document.getElementById('identityResult').classList.add('show');
                this.disabled = true;
                
                // æ ¹æ®èº«ä»½å†³å®šä¸‹ä¸€æ­¥
                setTimeout(() => {
                    if (selectedIdentity === "hunyuanzhu") {
                        // æ··å…ƒç ç›´æ¥ä½¿ç”¨ç‰¹æƒé¢˜ç›®
                        currentUser.question = CONFIG.QUESTION_BANKS.hunyuanzhu[0];
                        goToStep(4);
                        document.getElementById('completeBtn').disabled = false;
                    } else {
                        // çµç æˆ–é­”ä¸¸è¿›å…¥é¢˜ç›®æŠ½å–
                        goToStep(3);
                        document.getElementById('drawQuestionBtn').disabled = false;
                    }
                }, 1500);
            });
            
            // æŠ½å–é¢˜ç›®ï¼ˆä½¿ç”¨åŠ¨æ€æ¦‚ç‡ç³»ç»Ÿï¼‰
            document.getElementById('drawQuestionBtn').addEventListener('click', function() {
                if (!currentUser.identity) return;
                
                // ä½¿ç”¨æ¦‚ç‡ç³»ç»Ÿé€‰æ‹©é¢˜ç›®
                const selectedQuestion = probabilitySystem.selectQuestion(currentUser.identity.code);
                currentUser.question = selectedQuestion;
                
                console.log(`æŠ½ä¸­é¢˜ç›®: ${selectedQuestion.id}, ${selectedQuestion.text.substring(0, 30)}...`);
                
                // æ˜¾ç¤ºé¢˜ç›®
                document.getElementById('questionText').textContent = 
                    `${selectedQuestion.id}ï¼š${selectedQuestion.text}`;
                document.getElementById('questionResult').classList.add('show');
                this.disabled = true;
                
                setTimeout(() => {
                    goToStep(4);
                    document.getElementById('completeBtn').disabled = false;
                }, 1500);
            });
            
            // å®ŒæˆæŠ½ç­¾
            document.getElementById('completeBtn').addEventListener('click', function() {
                saveResult();
                currentUser.hasDrawn = true;
                this.disabled = true;
                this.textContent = 'âœ… å·²é”å®š';
                
                showFinalResult();
                
                alert(`ğŸ‰ æŠ½ç­¾å®Œæˆï¼æ‚¨æ˜¯ç¬¬${allResults.length}ä½å‚ä¸è€…ã€‚`);
            });
        }

        function goToStep(step) {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            document.getElementById(`step${step}`).style.display = 'block';
            
            setTimeout(() => {
                document.getElementById(`step${step}`).scrollIntoView({ 
                    behavior: 'smooth', block: 'start' 
                });
            }, 100);
        }

        function saveResult() {
            const result = {
                name: currentUser.name,
                deviceId: currentUser.deviceId,
                identity: currentUser.identity.name,
                code: currentUser.identity.code,
                question: currentUser.question.id ? 
                    `${currentUser.question.id}ï¼š${currentUser.question.text}` : 
                    currentUser.question.text,
                timestamp: new Date().toLocaleString('zh-CN'),
                serialNo: allResults.length + 1,
                questionId: currentUser.question.id || 'T'
            };
            
            allResults.push(result);
            localStorage.setItem('finance_results_v3', JSON.stringify(allResults));
            
            // è®°å½•åˆ°æ¦‚ç‡ç³»ç»Ÿ
            probabilitySystem.recordUsage(
                currentUser.identity.code,
                currentUser.question.id
            );
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸Šé™
            checkLimitStatus();
        }

        function showFinalResult() {
            document.getElementById('finalName').textContent = currentUser.name;
            const badge = document.getElementById('finalIdentityBadge');
            badge.textContent = currentUser.identity.name;
            badge.className = `badge ${currentUser.identity.code}-badge`;
            document.getElementById('finalQuestion').textContent = 
                currentUser.question.id ? 
                `${currentUser.question.id}ï¼š${currentUser.question.text}` : 
                currentUser.question.text;
            document.getElementById('finalResult').classList.add('show');
            
            const serialInfo = document.createElement('div');
            serialInfo.style.marginTop = '10px';
            serialInfo.style.fontSize = '14px';
            serialInfo.style.color = '#8D6E63';
            serialInfo.innerHTML = `ğŸ“ æ‚¨æ˜¯ç¬¬ <strong>${allResults.length}</strong> ä½å‚ä¸è€…`;
            document.getElementById('finalName').parentNode.appendChild(serialInfo);
        }

        // ==================== ç®¡ç†å‘˜åŠŸèƒ½ ====================
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                updateAdminStats();
            }
        }

        function updateAdminStats() {
            const uniqueDevices = new Set(allResults.map(r => r.deviceId)).size;
            const lingzhuCount = probabilitySystem.usedQuotas.lingzhu;
            const mowanCount = probabilitySystem.usedQuotas.mowan;
            const hunyuanCount = probabilitySystem.usedQuotas.hunyuanzhu;
            const totalUsed = lingzhuCount + mowanCount + hunyuanCount;
            
            document.getElementById('adminTotal').textContent = allResults.length;
            document.getElementById('adminUnique').textContent = uniqueDevices;
            document.getElementById('adminLingzhu').textContent = lingzhuCount;
            document.getElementById('adminMowan').textContent = mowanCount;
            document.getElementById('adminHunyuan').textContent = hunyuanCount;
            document.getElementById('adminRemaining').textContent = CONFIG.MAX_PARTICIPANTS - totalUsed;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // æ›´æ–°æ¦‚ç‡ç³»ç»Ÿæ˜¾ç¤º
            probabilitySystem.updateAdminPanel();
        }

        function exportAllData() {
            if (allResults.length === 0) {
                alert('æš‚æ— æ•°æ®');
                return;
            }
            
            const report = probabilitySystem.getDetailedReport();
            let csv = 'åºå·,å§“å,è®¾å¤‡ID,èº«ä»½,é¢˜ç›®ID,é¢˜ç›®,æŠ½ç­¾æ—¶é—´,æ¦‚ç‡æ‰¹æ¬¡\n';
            
            allResults.forEach((r, i) => {
                csv += `${i+1},"${r.name}","${r.deviceId}","${r.identity}","${r.questionId || ''}","${r.question.replace(/"/g, '""')}","${r.timestamp}","v3"\n`;
            });
            
            // æ·»åŠ æ¦‚ç‡æŠ¥å‘Š
            csv += '\n\n=== æ¦‚ç‡ç³»ç»ŸæŠ¥å‘Š ===\n';
            csv += 'é¡¹ç›®,åˆå§‹é…é¢,å·²ä½¿ç”¨,å‰©ä½™,å½“å‰æ¦‚ç‡\n';
            csv += `çµç ,${report.quotas.initial.lingzhu},${report.quotas.used.lingzhu},${report.quotas.remaining.lingzhu},${Math.round(report.probabilities.current.lingzhu * 100)}%\n`;
            csv += `é­”ä¸¸,${report.quotas.initial.mowan},${report.quotas.used.mowan},${report.quotas.remaining.mowan},${Math.round(report.probabilities.current.mowan * 100)}%\n`;
            csv += `æ··å…ƒç ,${report.quotas.initial.hunyuanzhu},${report.quotas.used.hunyuanzhu},${report.quotas.remaining.hunyuanzhu},${Math.round(report.probabilities.current.hunyuanzhu * 100)}%\n`;
            csv += `æ€»è®¡,30,${report.summary.totalParticipants},${report.summary.remainingSlots},-\n`;
            csv += `åˆ†é…å…¬å¹³æ€§,${report.summary.distributionFairness}%\n\n`;
            
            // æ·»åŠ é¢˜ç›®ä½¿ç”¨æƒ…å†µ
            csv += '=== é¢˜ç›®ä½¿ç”¨ç»Ÿè®¡ ===\n';
            csv += 'é¢˜åº“,é¢˜ç›®ID,ä½¿ç”¨æ¬¡æ•°\n';
            Object.keys(report.questionUsage).forEach(identity => {
                Object.keys(report.questionUsage[identity]).forEach(qId => {
                    csv += `${identity},${qId},${report.questionUsage[identity][qId]}\n`;
                });
            });
            
            downloadCSV(csv, 'è´¢åŠ¡ä¸­å¿ƒæŠ½ç­¾æ•°æ®');
            alert(`å·²å¯¼å‡º ${allResults.length} æ¡è®°å½•ï¼ŒåŒ…å«è¯¦ç»†æ¦‚ç‡æŠ¥å‘Š`);
        }

        function exportProbabilityReport() {
            const report = probabilitySystem.getDetailedReport();
            
            let csv = '=== åŠ¨æ€æ¦‚ç‡ç³»ç»Ÿè¯¦ç»†æŠ¥å‘Š ===\n';
            csv += `ç”Ÿæˆæ—¶é—´,${new Date().toLocaleString('zh-CN')}\n`;
            csv += `æ€»å‚ä¸äººæ•°,${report.summary.totalParticipants}/30\n`;
            csv += `å‰©ä½™åé¢,${report.summary.remainingSlots}\n`;
            csv += `åˆ†é…å…¬å¹³æ€§è¯„åˆ†,${report.summary.distributionFairness}%\n\n`;
            
            csv += '=== èº«ä»½é…é¢è¯¦æƒ… ===\n';
            csv += 'èº«ä»½,åˆå§‹é…é¢,å·²ä½¿ç”¨,å‰©ä½™é…é¢,åˆå§‹æ¦‚ç‡,å½“å‰æ¦‚ç‡,å˜åŒ–\n';
            
            ['lingzhu', 'mowan', 'hunyuanzhu'].forEach(identity => {
                const identityName = identity === 'lingzhu' ? 'çµç ' : 
                                  identity === 'mowan' ? 'é­”ä¸¸' : 'æ··å…ƒç ';
                const initialPct = Math.round(report.probabilities.initial[identity] * 100);
                const currentPct = Math.round(report.probabilities.current[identity] * 100);
                const change = currentPct - initialPct;
                
                csv += `${identityName},${report.quotas.initial[identity]},${report.quotas.used[identity]},${report.quotas.remaining[identity]},${initialPct}%,${currentPct}%,${change >= 0 ? '+' : ''}${change}%\n`;
            });
            
            csv += '\n=== é¢˜ç›®ä½¿ç”¨ç»Ÿè®¡ ===\n';
            csv += 'é¢˜åº“,é¢˜ç›®æ€»æ•°,æ€»ä½¿ç”¨æ¬¡æ•°,å¹³å‡ä½¿ç”¨,æœ€å¸¸ç”¨,æœ€å°‘ç”¨\n';
            
            Object.keys(report.questionUsage).forEach(identity => {
                const identityName = identity === 'lingzhu' ? 'çµç ' : 'é­”ä¸¸';
                const questions = CONFIG.QUESTION_BANKS[identity];
                const usage = report.questionUsage[identity];
                const totalUses = Object.values(usage).reduce((a, b) => a + b, 0);
                const avgUse = totalUses / questions.length;
                
                let maxUse = 0, minUse = Infinity;
                let maxQ = '', minQ = '';
                
                Object.keys(usage).forEach(qId => {
                    if (usage[qId] > maxUse) {
                        maxUse = usage[qId];
                        maxQ = qId;
                    }
                    if (usage[qId] < minUse) {
                        minUse = usage[qId];
                        minQ = qId;
                    }
                });
                
                csv += `${identityName},${questions.length},${totalUses},${avgUse.toFixed(1)},${maxQ}(${maxUse}æ¬¡),${minQ}(${minUse}æ¬¡)\n`;
            });
            
            csv += '\n=== è¯¦ç»†é¢˜ç›®ä½¿ç”¨ ===\n';
            csv += 'é¢˜åº“,é¢˜ç›®ID,ä½¿ç”¨æ¬¡æ•°,ä½¿ç”¨æ¯”ä¾‹\n';
            
            Object.keys(report.questionUsage).forEach(identity => {
                const identityName = identity === 'lingzhu' ? 'çµç ' : 'é­”ä¸¸';
                const totalUses = Object.values(report.questionUsage[identity]).reduce((a, b) => a + b, 0);
                
                Object.keys(report.questionUsage[identity]).forEach(qId => {
                    const uses = report.questionUsage[identity][qId];
                    const proportion = totalUses > 0 ? (uses / totalUses * 100).toFixed(1) : 0;
                    csv += `${identityName},${qId},${uses},${proportion}%\n`;
                });
            });
            
            downloadCSV(csv, 'æ¦‚ç‡ç³»ç»Ÿè¯¦ç»†æŠ¥å‘Š');
            alert('æ¦‚ç‡æŠ¥å‘Šå·²å¯¼å‡º');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showAllResults() {
            const report = probabilitySystem.getDetailedReport();
            
            let resultsText = `=== æŠ½ç­¾ç»Ÿè®¡ ===\n`;
            resultsText += `æ€»æŠ½ç­¾æ•°: ${allResults.length}\n`;
            resultsText += `ç‹¬ç«‹è®¾å¤‡: ${new Set(allResults.map(r => r.deviceId)).size}\n`;
            resultsText += `å‰©ä½™åé¢: ${report.summary.remainingSlots}\n`;
            resultsText += `åˆ†é…å…¬å¹³æ€§: ${report.summary.distributionFairness}%\n\n`;
            
            resultsText += `=== èº«ä»½åˆ†å¸ƒ ===\n`;
            resultsText += `çµç : ${report.quotas.used.lingzhu}äºº (åˆå§‹é…é¢: ${report.quotas.initial.lingzhu})\n`;
            resultsText += `é­”ä¸¸: ${report.quotas.used.mowan}äºº (åˆå§‹é…é¢: ${report.quotas.initial.mowan})\n`;
            resultsText += `æ··å…ƒç : ${report.quotas.used.hunyuanzhu}äºº (åˆå§‹é…é¢: ${report.quotas.initial.hunyuanzhu})\n\n`;
            
            resultsText += `=== å½“å‰æ¦‚ç‡ ===\n`;
            resultsText += `çµç : ${Math.round(report.probabilities.current.lingzhu * 100)}%\n`;
            resultsText += `é­”ä¸¸: ${Math.round(report.probabilities.current.mowan * 100)}%\n`;
            resultsText += `æ··å…ƒç : ${Math.round(report.probabilities.current.hunyuanzhu * 100)}%\n\n`;
            
            resultsText += `=== è¯¦ç»†è®°å½• ===\n`;
            resultsText += allResults.map(r => 
                `ã€${r.serialNo}ã€‘${r.name} - ${r.identity}\n` +
                `é¢˜ç›®ï¼š${r.question}\n` +
                `æ—¶é—´ï¼š${r.timestamp}\n` +
                `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`
            ).join('\n\n');
            
            alert(resultsText || 'æš‚æ— æ•°æ®');
        }

        // ==================== é‡ç½®ç³»ç»ŸåŠŸèƒ½ ====================
        function resetSystemWithPassword() {
            const passwordInput = document.getElementById('resetPassword');
            const password = passwordInput.value.trim();
            const statusDiv = document.getElementById('passwordStatus');
            
            // æ¸…ç©ºçŠ¶æ€æ˜¾ç¤º
            statusDiv.className = 'password-status';
            statusDiv.textContent = '';
            
            if (!password) {
                statusDiv.textContent = 'è¯·è¾“å…¥å¯†ç ';
                statusDiv.className = 'password-status error';
                return;
            }
            
            if (password !== CONFIG.RESET_PASSWORD) {
                statusDiv.textContent = 'å¯†ç é”™è¯¯';
                statusDiv.className = 'password-status error';
                passwordInput.value = '';
                return;
            }
            
            // ç¡®è®¤é‡ç½®
            if (!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦é‡ç½®å…¨éƒ¨æ•°æ®å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤æ‰€æœ‰æŠ½ç­¾è®°å½•å’Œæ¦‚ç‡çŠ¶æ€ï¼Œç³»ç»Ÿå°†æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚\næ­¤æ“ä½œä¸å¯é€†ï¼')) {
                statusDiv.textContent = 'å·²å–æ¶ˆé‡ç½®';
                statusDiv.className = 'password-status';
                passwordInput.value = '';
                return;
            }
            
            // æ‰§è¡Œé‡ç½®
            performSystemReset();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            statusDiv.textContent = 'âœ… ç³»ç»Ÿå·²æˆåŠŸé‡ç½®ï¼';
            statusDiv.className = 'password-status success';
            
            // æ¸…ç©ºå¯†ç æ¡†
            passwordInput.value = '';
            
            // 3ç§’åæ¸…ç©ºçŠ¶æ€æ¶ˆæ¯
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'password-status';
            }, 3000);
        }

        function performSystemReset() {
            // 1. æ¸…ç©ºæ‰€æœ‰ç»“æœæ•°æ®
            allResults = [];
            localStorage.removeItem('finance_results_v3');
            
            // 2. æ¸…ç©ºæ¦‚ç‡ç³»ç»Ÿæ•°æ®
            probabilitySystem.resetSystem();
            
            // 3. é‡ç½®è®¾å¤‡IDï¼ˆå¯é€‰ï¼Œå¦‚æœå¸Œæœ›å®Œå…¨é‡æ–°å¼€å§‹ï¼‰
            // localStorage.removeItem('finance_device_id_v3');
            
            // 4. é‡ç½®å½“å‰ç”¨æˆ·çŠ¶æ€
            currentUser = {
                deviceId: currentUser.deviceId, // ä¿ç•™è®¾å¤‡IDï¼Œä½†é‡ç½®å…¶ä»–çŠ¶æ€
                name: '',
                hasDrawn: false,
                isDrawing: false,
                identity: null,
                question: null
            };
            
            // 5. é‡ç½®é¡µé¢çŠ¶æ€
            isLimitReached = false;
            
            // 6. é‡ç½®UIæ˜¾ç¤º
            document.getElementById('userName').value = '';
            document.getElementById('userName').disabled = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'å¼€å§‹æŠ½ç­¾';
            
            // 7. éšè—æ‰€æœ‰è­¦å‘Šå’Œç»“æœ
            document.getElementById('duplicateWarning').style.display = 'none';
            document.getElementById('deviceWarning').style.display = 'none';
            document.getElementById('notInListWarning').style.display = 'none';
            document.getElementById('limitWarning').style.display = 'none';
            document.getElementById('nameStatus').style.display = 'none';
            
            // 8. é‡ç½®æ­¥éª¤åˆ°ç¬¬ä¸€æ­¥
            goToStep(1);
            
            // 9. æ›´æ–°ç®¡ç†é¢æ¿ç»Ÿè®¡
            updateAdminStats();
            
            // 10. é‡æ–°æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
            checkUserStatus();
            checkLimitStatus();
            
            console.log('ç³»ç»Ÿå·²é‡ç½®ï¼Œæ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
            alert('ğŸ‰ ç³»ç»Ÿé‡ç½®æˆåŠŸï¼\n\næ‰€æœ‰æŠ½ç­¾è®°å½•å·²æ¸…é™¤ï¼Œç³»ç»Ÿå·²æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚\nç°åœ¨å¯ä»¥å¼€å§‹æ–°çš„æŠ½ç­¾äº†ã€‚');
        }

        // å…¨å±€å¯¼å‡ºå‡½æ•°
        window.exportAllData = exportAllData;
        window.exportProbabilityReport = exportProbabilityReport;
        window.showAllResults = showAllResults;
        window.toggleAdminPanel = toggleAdminPanel;
        window.resetSystemWithPassword = resetSystemWithPassword;
        window.performSystemReset = performSystemReset;
        window.probabilitySystem = probabilitySystem; // æš´éœ²æ¦‚ç‡ç³»ç»Ÿä¾›è°ƒè¯•

        console.log('âœ… æŠ½ç­¾ç³»ç»Ÿå·²å°±ç»ª');
        console.log('åˆå§‹é…é¢: çµç 12äºº, é­”ä¸¸12äºº, æ··å…ƒç 6äºº');
        console.log('é‡ç½®å¯†ç : ' + CONFIG.RESET_PASSWORD);
        console.log('æ¦‚ç‡ç³»ç»Ÿ:', probabilitySystem.getDetailedReport());
    </script>
</body>
</html>
